<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiprofil</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js" integrity="sha512-aNMyYYxdIxIaot0Y1/PLuEu3eipGCmsEUBrUq+7aVyPGMFH8z0eTP0tkqAvv34fzN6z+201d3T8HPb1svWSKHQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --hp-blue-900: #0b2f66;
      --hp-blue-700: #174ea6;
      --hp-blue-500: #2f6ee5;
      --hp-ink: #0f1f3d;
      --hp-bg: #f4f8ff;
      --hp-card: #ffffff;
      --hp-line: #d5e3ff;
    }

    body {
      font-family: "Plus Jakarta Sans", sans-serif;
      color: var(--hp-ink);
      background:
        radial-gradient(circle at 10% -10%, #d8e8ff 0%, transparent 30%),
        radial-gradient(circle at 90% -20%, #c7dcff 0%, transparent 32%),
        var(--hp-bg);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  
  <div id="sierra-header-root"></div>
  <div id="sierra-hero-root"></div>
  <div id="sierra-cv-price-notice-root"></div>
  
  <div id="sierra-cv-features-root"></div>
  <div id="sierra-cv-hero-root"></div>
  <div id="sierra-cv-examples-hero-root"></div>
  <div id="sierra-cv-main-hero-root"></div>
  <div id="sierra-cv-full-features-root"></div>
  <div id="sierra-cv-easy-hero-root"></div>
  <div id="sierra-cv-resources-hero-root"></div>
  <div id="sierra-cv-resources-hero-alt-root"></div>
  <div id="sierra-cv-resources-hero-v2-root"></div>
  <div id="sierra-cv-steps-faq-root"></div>
  <div id="sierra-cv-cta-footer-root"></div>

  <script type="module">
    import HeaderComponent from "./header.js";
    import HeroComponent from "./hero.js";
    import { initAuth } from "./auth.js";
    import { initAccountPanel } from "./accountPanel.js";
    import { initCvAccessFlow } from "./cvAccessFlow.js";
    import { initDepositFlow } from "./depositFlow.js";

    const sectionModulesCritical = [
      "./cvPriceNotice.js",
      "./cvHero.js",
      "./cvFeatures.js",
      "./cvExamplesHero.js"
    ];
    const sectionModulesDeferred = [
      "./cvMainHero.js",
      "./cvFullFeatures.js",
      "./cvEasyHero.js",
      "./cvResourcesHero.js",
      "./cvResourcesHeroAlt.js",
      "./cvResourcesHeroV2.js",
      "./cvStepsFaq.js",
      "./cvCtaFooter.js"
    ];
    const motionModulesDeferred = [
      "./nobgMotion.js",
      "./sectionBgMotion.js",
      "./scrollSceneMotion.js",
      "./imageScrollMotion.js"
    ];

    const loadModules = (paths) => Promise.all(paths.map((path) => import(path)));
    const scheduleIdle = (task, timeout = 1200) => {
      if (typeof window.requestIdleCallback === "function") {
        window.requestIdleCallback(() => task(), { timeout });
        return;
      }
      window.setTimeout(task, 80);
    };
    const appendResourceHint = (rel, href, options = {}) => {
      const absoluteHref = new URL(href, window.location.href).href;
      if (document.querySelector(`link[rel="${rel}"][href="${absoluteHref}"]`)) return;
      const link = document.createElement("link");
      link.rel = rel;
      link.href = absoluteHref;
      if (options.as) link.as = options.as;
      document.head.appendChild(link);
    };

    let builderNavigationPrefetched = false;
    const prefetchBuilderNavigation = () => {
      if (builderNavigationPrefetched) return;
      builderNavigationPrefetched = true;
      appendResourceHint("prefetch", "./index.html?open=builder");
      appendResourceHint("modulepreload", "./buildercv.js");
      appendResourceHint("modulepreload", "./previsualisation.js");
      appendResourceHint("modulepreload", "./tips.js");
    };

    const authApi = initAuth();
    initAccountPanel(authApi);
    initCvAccessFlow(authApi);
    initDepositFlow(authApi);
    new HeaderComponent("sierra-header-root", { authApi });
    new HeroComponent("sierra-hero-root");

    loadModules(sectionModulesCritical).catch((error) => {
      console.error("Echec chargement sections critiques:", error);
    });
    scheduleIdle(() => {
      loadModules(sectionModulesDeferred).catch((error) => {
        console.error("Echec chargement sections differees:", error);
      });
    }, 900);
    scheduleIdle(() => {
      loadModules(motionModulesDeferred).catch((error) => {
        console.error("Echec chargement animations differees:", error);
      });
    }, 1800);

    const syncAuthButtonsVisibility = (user) => {
      const isConnected = Boolean(user);
      const transformSelectors = [
        "[data-auth-mode]"
      ];

      document.querySelectorAll(transformSelectors.join(",")).forEach((node) => {
        if (!(node instanceof HTMLButtonElement)) return;
        if (!node.dataset.authOriginalText) {
          node.dataset.authOriginalText = node.textContent?.trim() || "";
        }
        if (!node.dataset.authOriginalMode) {
          node.dataset.authOriginalMode = node.getAttribute("data-auth-mode") || "";
        }
        if (!node.dataset.authOriginalAction) {
          node.dataset.authOriginalAction = node.getAttribute("data-action") || "";
        }

        if (isConnected) {
          node.textContent = "Commencer mon CV";
          node.removeAttribute("data-auth-mode");
          node.removeAttribute("data-action");
          node.setAttribute("data-cv-start", "1");
          return;
        }

        node.textContent = node.dataset.authOriginalText || node.textContent;
        node.removeAttribute("data-cv-start");
        if (node.dataset.authOriginalMode) {
          node.setAttribute("data-auth-mode", node.dataset.authOriginalMode);
        } else {
          node.removeAttribute("data-auth-mode");
        }
        if (node.dataset.authOriginalAction) {
          node.setAttribute("data-action", node.dataset.authOriginalAction);
        } else {
          node.removeAttribute("data-action");
        }
      });

      const hideSelectors = [
        '[data-action="google"]',
        '[data-action="open-login"]',
        '[data-action="open-signup"]'
      ];
      document.querySelectorAll(hideSelectors.join(",")).forEach((node) => {
        if (!(node instanceof HTMLElement)) return;
        node.classList.toggle("hidden", isConnected);
      });
    };

    syncAuthButtonsVisibility(authApi.getCurrentUser());
    window.addEventListener("auth:changed", (event) => {
      syncAuthButtonsVisibility(event?.detail?.user || null);
    });

    const maybePrefetchBuilderNavigation = (event) => {
      if (!(event.target instanceof Element)) return;
      if (!event.target.closest("[data-cv-start]")) return;
      prefetchBuilderNavigation();
    };
    document.addEventListener("pointerover", maybePrefetchBuilderNavigation, { passive: true });
    document.addEventListener("pointerdown", maybePrefetchBuilderNavigation, { passive: true });
    document.addEventListener("focusin", maybePrefetchBuilderNavigation);

    document.addEventListener("click", (event) => {
      if (event.target.closest("[data-cv-start]")) {
        prefetchBuilderNavigation();
        window.dispatchEvent(new CustomEvent("app:request-cv-start"));
        return;
      }
      const trigger = event.target.closest("[data-auth-mode]");
      if (!trigger) return;
      const mode = trigger.getAttribute("data-auth-mode") || "login";
      authApi.open(mode);
    });
  </script>
</body>
</html>
