<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hiprofil</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.2/anime.min.js" integrity="sha512-aNMyYYxdIxIaot0Y1/PLuEu3eipGCmsEUBrUq+7aVyPGMFH8z0eTP0tkqAvv34fzN6z+201d3T8HPb1svWSKHQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --hp-blue-900: #0b2f66;
      --hp-blue-700: #174ea6;
      --hp-blue-500: #2f6ee5;
      --hp-ink: #0f1f3d;
      --hp-bg: #f4f8ff;
      --hp-card: #ffffff;
      --hp-line: #d5e3ff;
    }

    body {
      font-family: "Plus Jakarta Sans", sans-serif;
      color: var(--hp-ink);
      background:
        radial-gradient(circle at 10% -10%, #d8e8ff 0%, transparent 30%),
        radial-gradient(circle at 90% -20%, #c7dcff 0%, transparent 32%),
        var(--hp-bg);
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <main id="home-content">
    <div id="sierra-header-root"></div>
    <div id="sierra-hero-root"></div>
    
    <div id="sierra-cv-features-root"></div>
    <div id="sierra-cv-hero-root"></div>
    <div id="sierra-cv-examples-hero-root"></div>
    <div id="sierra-cv-main-hero-root"></div>
    <div id="sierra-cv-full-features-root"></div>
    <div id="sierra-cv-easy-hero-root"></div>
    <div id="sierra-cv-resources-hero-root"></div>
    <div id="sierra-cv-resources-hero-alt-root"></div>
    <div id="sierra-cv-resources-hero-v2-root"></div>
    <div id="sierra-cv-steps-faq-root"></div>
    <div id="sierra-cv-cta-footer-root"></div>
  </main>

  <section id="builder-section" hidden aria-hidden="true" class="fixed inset-0 z-50 bg-slate-900">
    <builder-cv id="builder-cv"></builder-cv>
    <previsualisation-cv id="previsualisation-cv" hidden></previsualisation-cv>
    <tips-modal id="tips-modal"></tips-modal>
    <div id="builder-open-loader" class="absolute inset-0 z-[85] hidden items-center justify-center bg-slate-950/72 backdrop-blur-sm" aria-live="polite" aria-busy="true">
      <div class="w-[min(92vw,360px)] rounded-2xl border border-slate-700/70 bg-slate-900/95 px-5 py-4 shadow-2xl">
        <div class="flex items-center gap-3">
          <span class="inline-block h-7 w-7 animate-spin rounded-full border-[3px] border-slate-500 border-t-sky-400"></span>
          <p id="builder-open-loader-text" class="text-sm font-semibold text-slate-100">Preparation du builder...</p>
        </div>
      </div>
    </div>
  </section>

  <script type="module">
    import HeaderComponent from "./header.js";
    import HeroComponent from "./hero.js";
    import { initAuth } from "./auth.js";
    import { initAccountPanel } from "./accountPanel.js";
    import { initCvAccessFlow } from "./cvAccessFlow.js";
    import { initDepositFlow } from "./depositFlow.js";

    const sectionModulesCritical = [
      "./cvHero.js",
      "./cvFeatures.js",
      "./cvExamplesHero.js"
    ];
    const sectionModulesDeferred = [
      "./cvMainHero.js",
      "./cvFullFeatures.js",
      "./cvEasyHero.js",
      "./cvResourcesHero.js",
      "./cvResourcesHeroAlt.js",
      "./cvResourcesHeroV2.js",
      "./cvStepsFaq.js",
      "./cvCtaFooter.js"
    ];
    const motionModulesDeferred = [
      "./nobgMotion.js",
      "./sectionBgMotion.js",
      "./scrollSceneMotion.js",
      "./imageScrollMotion.js"
    ];
    const builderModules = [
      "./buildercv.js",
      "./previsualisation.js",
      "./tips.js"
    ];

    const loadModules = (paths) => Promise.all(paths.map((path) => import(path)));
    const scheduleIdle = (task, timeout = 1200) => {
      if (typeof window.requestIdleCallback === "function") {
        window.requestIdleCallback(() => task(), { timeout });
        return;
      }
      window.setTimeout(task, 80);
    };

    let builderModulesReadyPromise = null;
    const ensureBuilderModulesLoaded = async () => {
      if (!builderModulesReadyPromise) {
        builderModulesReadyPromise = (async () => {
          await loadModules(builderModules);
          await Promise.all([
            customElements.whenDefined("builder-cv"),
            customElements.whenDefined("previsualisation-cv"),
            customElements.whenDefined("tips-modal")
          ]);
        })().catch((error) => {
          builderModulesReadyPromise = null;
          throw error;
        });
      }
      return builderModulesReadyPromise;
    };

    const authApi = initAuth();
    initAccountPanel(authApi);
    initCvAccessFlow(authApi);
    initDepositFlow(authApi);
    new HeaderComponent("sierra-header-root", { authApi });
    new HeroComponent("sierra-hero-root");

    loadModules(sectionModulesCritical).catch((error) => {
      console.error("Echec chargement sections critiques:", error);
    });
    scheduleIdle(() => {
      loadModules(sectionModulesDeferred).catch((error) => {
        console.error("Echec chargement sections differees:", error);
      });
    }, 900);
    scheduleIdle(() => {
      loadModules(motionModulesDeferred).catch((error) => {
        console.error("Echec chargement animations differees:", error);
      });
    }, 1800);
    let builderPrefetchDone = false;
    const triggerBuilderPrefetch = () => {
      if (builderPrefetchDone) return;
      builderPrefetchDone = true;
      void ensureBuilderModulesLoaded().catch((error) => {
        builderPrefetchDone = false;
        console.error("Echec prechargement builder:", error);
      });
    };
    scheduleIdle(() => {
      triggerBuilderPrefetch();
    }, 2200);

    const builderSection = document.getElementById("builder-section");
    const homeContent = document.getElementById("home-content");
    const builderComponent = document.getElementById("builder-cv");
    const previewComponent = document.getElementById("previsualisation-cv");
    const tipsModal = document.getElementById("tips-modal");
    const builderOpenLoader = document.getElementById("builder-open-loader");
    const builderOpenLoaderText = document.getElementById("builder-open-loader-text");
    let builderLoaderTimer = null;
    let isOpeningBuilder = false;

    const showBuilderLoader = (message = "Preparation du builder...") => {
      if (!(builderOpenLoader instanceof HTMLElement)) return;
      if (builderOpenLoaderText) builderOpenLoaderText.textContent = message;
      if (builderLoaderTimer) {
        clearTimeout(builderLoaderTimer);
      }
      builderLoaderTimer = window.setTimeout(() => {
        builderLoaderTimer = null;
        builderOpenLoader.classList.remove("hidden");
        builderOpenLoader.classList.add("flex");
      }, 120);
    };

    const hideBuilderLoader = () => {
      if (!(builderOpenLoader instanceof HTMLElement)) return;
      if (builderLoaderTimer) {
        clearTimeout(builderLoaderTimer);
        builderLoaderTimer = null;
      }
      builderOpenLoader.classList.add("hidden");
      builderOpenLoader.classList.remove("flex");
    };

    const updateOpenBuilderParam = (enabled) => {
      const url = new URL(window.location.href);
      if (enabled) {
        url.searchParams.set("open", "builder");
      } else {
        url.searchParams.delete("open");
      }
      window.history.replaceState({}, "", url);
    };

    const openBuilder = async () => {
      if (!builderSection || !homeContent || !builderComponent || !previewComponent) return;
      if (isOpeningBuilder) return;
      isOpeningBuilder = true;
      homeContent.hidden = true;
      builderSection.hidden = false;
      builderSection.setAttribute("aria-hidden", "false");
      builderComponent.hidden = true;
      previewComponent.hidden = true;
      showBuilderLoader("Preparation du builder...");
      try {
        await ensureBuilderModulesLoaded();
        hideBuilderLoader();
        builderComponent.hidden = false;
        previewComponent.hidden = true;
        if (typeof builderComponent.resetFlow === "function") {
          builderComponent.resetFlow();
        }
        if (tipsModal && typeof tipsModal.close === "function") {
          tipsModal.close();
        }
        document.body.classList.add("overflow-hidden");
        updateOpenBuilderParam(true);
      } catch (error) {
        console.error("Impossible de charger le builder:", error);
        hideBuilderLoader();
        builderSection.hidden = true;
        builderSection.setAttribute("aria-hidden", "true");
        homeContent.hidden = false;
        document.body.classList.remove("overflow-hidden");
        return;
      } finally {
        isOpeningBuilder = false;
      }
    };

    const closeBuilder = () => {
      if (!builderSection || !homeContent || !builderComponent || !previewComponent) return;
      hideBuilderLoader();
      builderSection.hidden = true;
      builderSection.setAttribute("aria-hidden", "true");
      builderComponent.hidden = false;
      previewComponent.hidden = true;
      homeContent.hidden = false;
      if (tipsModal && typeof tipsModal.close === "function") {
        tipsModal.close();
      }
      document.body.classList.remove("overflow-hidden");
      updateOpenBuilderParam(false);
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    const openPreview = (data) => {
      if (!builderComponent || !previewComponent) return;
      hideBuilderLoader();
      builderComponent.hidden = true;
      previewComponent.hidden = false;
      if (tipsModal && typeof tipsModal.close === "function") {
        tipsModal.close();
      }
      if (typeof previewComponent.loadData === "function") {
        previewComponent.loadData(data);
      }
    };

    const backToBuilder = () => {
      if (!builderComponent || !previewComponent) return;
      previewComponent.hidden = true;
      builderComponent.hidden = false;
    };

    const syncAuthButtonsVisibility = (user) => {
      const isConnected = Boolean(user);
      const transformSelectors = [
        "[data-auth-mode]",
        '[data-action="hero-google-login"]'
      ];

      document.querySelectorAll(transformSelectors.join(",")).forEach((node) => {
        if (!(node instanceof HTMLButtonElement)) return;
        if (!node.dataset.authOriginalText) {
          node.dataset.authOriginalText = node.textContent?.trim() || "";
        }
        if (!node.dataset.authOriginalMode) {
          node.dataset.authOriginalMode = node.getAttribute("data-auth-mode") || "";
        }
        if (!node.dataset.authOriginalAction) {
          node.dataset.authOriginalAction = node.getAttribute("data-action") || "";
        }

        if (isConnected) {
          node.textContent = "Commencer mon CV";
          node.removeAttribute("data-auth-mode");
          node.removeAttribute("data-action");
          node.setAttribute("data-cv-start", "1");
          return;
        }

        node.textContent = node.dataset.authOriginalText || node.textContent;
        node.removeAttribute("data-cv-start");
        if (node.dataset.authOriginalMode) {
          node.setAttribute("data-auth-mode", node.dataset.authOriginalMode);
        } else {
          node.removeAttribute("data-auth-mode");
        }
        if (node.dataset.authOriginalAction) {
          node.setAttribute("data-action", node.dataset.authOriginalAction);
        } else {
          node.removeAttribute("data-action");
        }
      });

      const hideSelectors = [
        '[data-action="google"]',
        '[data-action="open-login"]',
        '[data-action="open-signup"]'
      ];
      document.querySelectorAll(hideSelectors.join(",")).forEach((node) => {
        if (!(node instanceof HTMLElement)) return;
        node.classList.toggle("hidden", isConnected);
      });
    };

    syncAuthButtonsVisibility(authApi.getCurrentUser());
    window.addEventListener("auth:changed", (event) => {
      syncAuthButtonsVisibility(event?.detail?.user || null);
    });

    const maybePrefetchBuilderOnIntent = (event) => {
      if (!(event.target instanceof Element)) return;
      if (!event.target.closest("[data-cv-start]")) return;
      triggerBuilderPrefetch();
    };
    document.addEventListener("pointerover", maybePrefetchBuilderOnIntent, { passive: true });
    document.addEventListener("pointerdown", maybePrefetchBuilderOnIntent, { passive: true });
    document.addEventListener("focusin", maybePrefetchBuilderOnIntent);

    document.addEventListener("click", (event) => {
      if (event.target.closest("[data-cv-start]")) {
        event.preventDefault();
        window.dispatchEvent(new CustomEvent("app:request-cv-start"));
        return;
      }
      const trigger = event.target.closest("[data-auth-mode]");
      if (!trigger) return;
      const mode = trigger.getAttribute("data-auth-mode") || "login";
      authApi.open(mode);
    });

    window.addEventListener("app:open-builder", () => {
      void openBuilder();
    });
    if (builderSection) {
      builderSection.addEventListener("close-builder", closeBuilder);
      builderSection.addEventListener("open-tip", (event) => {
        const field = event.detail && event.detail.field;
        const label = event.detail && event.detail.label;
        if (tipsModal && typeof tipsModal.open === "function") {
          tipsModal.open(field, label);
        }
      });
      builderSection.addEventListener("builder-finished", (event) => {
        openPreview(event.detail);
      });
      builderSection.addEventListener("preview-back", backToBuilder);
    }

    const params = new URLSearchParams(window.location.search);
    if (params.get("open") === "builder") {
      void openBuilder();
    }
  </script>
</body>
</html>
